---
author:
  name: "Justin Restivo"
date: 2021-01-10
title: Deploying hakyll blog with nix and github actions
---

# Motivation #

My blog was originally running on hugo with nginx on a digitalocean server.
But, it's a static site! I shouldn't need to pay to host it on a server 
when I could just be deploying to github pages for free.

I recently tried to pick up
[haskell](https://github.com/DieracDelta/advent-of-code-2020), and wanted to
configure my blog in haskell. This can be done through
[hakyll](https://jaspervdj.be/hakyll/). I get the same benefits that hugo
provides (e.g. static site generation from markdown files, except with pandoc)
; the configuration part is a bit easier and more powerful since it's in haskell
instead of a yaml file.

My vision was to have hakyll be able to convert my markdown, css/html templates,
and haskell config file into a static website. *I* also didn't want to do this
every time I had a modification. The workflow I envisioned went like:

- push modified markdown, css/html template, haskell config to github
- github would grab `nix` on a build server and use nix flakes to convert
  to a static website.
- that static website would be pushed to a separate branch of the repo that is
  deployed to github pages and link with my CNAME (justin.restivo.me)

# Building as a flake #

The first thing to do was figure out how to generate the blog using `nixFlake`.
Luckily, [this guy](https://github.com/zarybnicky/zarybnicky.com/blob/master/flake.nix)
had already done this in a readable manner. However, he was hosting on a nginx
instance, which I didn't want, so I cut some of what he did. The barebones
is just in my [`flake.nix`](https://github.com/DieracDelta/DieracDelta.github.io/blob/master/flake.nix)
file.

This flake builds hakyll, then the static site (`builder`) then copies the
generated site (plus `CNAME`) to `$out`. I was then able to get `nix` to deploy
using the process described [here](https://mpickering.github.io/posts/2019-06-24-overkill-or-not.html) and [here](https://github.com/rpearce/hakyll-nix-template). Note that I didn't realize
this template existed until after I had put together this tooling. The template's 
nix tooling is quite nice.

The CI steps are:

- Use the checkout action to clone the repo
- Use the [`cachix/install-nix-action`](https://github.com/cachix/install-nix-action) to install nix flakes.
- Run the `nix build . -o site` to build the flake and put the result in
  the `site` subdirectory.
- Use [crazy-max](https://github.com/crazy-max/ghaction-github-pages)
  deploy to github pages action. This requires a `GITHUB_TOKEN` which is
  already autogenerated by github. It looks at the `build_dir` field to figure
  out what to deploy, then pushes that folder to the `target_branch` field (`gh-pages`).
  This is then read in by github pages and deployed to the website in `site/CNAME`
  (which was generated with the `flake.nix`).

# Configuration #

Generating the blog content is done by first `nix develop`-ing, then running
`hakyll-init` in the root directory; this generates the template to modify.
Then building is as easy as:

``` bash
nix build .
```

The website workflow is easy to control from the `Main.hs` file, and the 
template's css and html is easy enough to modify as well.

As with all static website generators, live refresh upon modification of 
css is a must for rapid prototyping. Hakyll allows this via:

``` bash
nix develop
site --watch
```

# Google Analytics #

I'm also interested in data, and one way to get data is to hook
the site into google analytics. Google gives your site a script to put in the
`HEAD` of each page, and it will provide you with analytics based on the 
requests to the page. I've done this and it's pretty nifty 
(though I'm the only user). Hakyll makes this easy, since all I need do is 
modify the template used to include the analytics script and boom it's 
on all webpages.

# Adding style #

To make the site look a little less outdated, I'm using `nerdfonts`. This was
as easy as including a line in the `HEAD` section and a little bit of `css` 
per nerdfont README.

